#About the FELIX-GBT module example in the PCIe+GBT project

1. The project: includes the PCIE interface and the implementation of the 4-channel FELIX-GBT module.

2. Basics about the 4-ch FELIX GBT module.  
	- The module contains two parts: GBT encoding/decoding, and the Xilinx GTH IP. Some of the GBT encoding/decoding code is from CERN GBT-FPGA, the unit for GBT encoding/decoding is 1 channel. The Xilinx GTH IP is generated by Vivado 2014.4, the unit is 1 Quad.
	- The differences of the GBT encoding/decoding, with CERN GBT-FPGA core for Xilinx 7 series FPGA:
		- The interface to the GTH transceiver is 240Mx20b, to decrease the latency. The CERN core for 7 series use 120Mx40b as default.
		- The scrambler, descrambler, decoder and encoder are all run in the 240MHz domain, to decrease the latency. CERN core is run in the 40MHz domain.
		- The rx alignment is redesigned.
		- The GBT encoding/decoding modes (FEC and Wide-Bus) can be changed without reprogramming the FPGA.
	- The GTH IP is seperated from the GBT encoding/decoding.
		- The 240M for GBT encoding and TxUsrClk can be from local 240M or TxOutClk. The TxOutClk is recommended.
		- The 240M for GBT decoding and RxUsrClk can be from local 240M or RxOutClk of one master receiver link. If TTC clock is from TTC link, then local 240M is recommended. If the TTC clock needs to be recovered from the GBT link, then for this quad, we can use master channel RxOutClk as RxUsrClk. For other quads, both modes can be used, but local 240M is recommended.
		- Both versions with QPLL and CPLL are provided.
		- The GTH reference clock can be from the MGTRefClk pin, or GRefClk. When using CPLL, please use MGTRefClk to drive the GTH reference clock.
		- Some modifications are done to the GTH IP generated by Vivado, to decrease latency, and to support the RxUsrClk clock sharing between multiple channels.
	- Loopback latency: we connect one bit from the Tx 120b data (to FELIX GBT), and Rx 120b data (from FELIX GBT), to SMA connectors.
		- FEC mode: about 111~113 ns. (The routing to the two SMA connectors will change +-1 ns, when firmware is changed and recompiled.)
		- Wide-Bus mode: about 103~105 ns.
		- Compare with the CERN GBT-FPGA project.
			- KC705, use 120M x 40b: 214 ns
			- ML605, use 240M x 20b: 130 ns. (V6 transceiver latency is several nanoseconds smaller than 7 series.)

	- For this test project, GRefClk is used to drive the GTH reference clock. It can be changed to MGTRefClk in the package file.
	- For this test project, QPLL of GTH is used.
	- This FELIX-GBT module has been verified by a 24-channel projects run in HTG-710 board. Phase of the RxOutClk of different channel can be different (In the package file, the phase\_adjust can be enabled, which delay the bit flow in different channel with different UI, to make the RxOutClk has different phase).

3. How to test the example 4-ch project.
   This project is for HTG-710 board, and it will be ported to VC709.  
   There are two generated bit files in python_scripts: localRxUsrClk.bit and RecRxUsrClk.bit.  
	- localRxUsrClk.bit use local 240M to drive the RxUsrClk of all channels, similar with FELIX.
		- The chipscope can be used to do the simple test. Rx alignment in firmware is used.
			- set ctrl\_sel to 1.
			- set RX\_LATOPT\_DES, Tx\_latopt\_scr and Tx\_latopt\_tc to 0xF.
			- trigger SOFT\_RESET.
			- trigger SOFT\_TX\_RESET.
			- trigger GBTTXRST.
			- trigger GTRX\_RESET.
			- the GBT\_DATA\_TXFORMAT and GBT\_DATA\_RXFORMAT can be changed between 0x00 and 0x55, to change the GBT mode.
			- the TX\_DELAY\_SEL can be changed to adjust the time domain crossing from the 40MHz TxFrameClk to 240MHz TxUsrClk.
		- The Python scripts can be used to do more configurations.
			- Use firmware to do the rx alignment.  
				- Run *python gbt\_config\_localRxUsrClk\_FW.py 0* to test it. 0 means FEC mode, change to 1 for Wide-bus mode.
			- Use software to do the rx alignment.
				- Similarly, run *python gbt\_config\_localRxUsrClk\_SW.py 0*, use 1 for Wide-bus mode.
	- RecRxUsrClk.bit use RxOutClk of the master channel to drive the RxUsrClk of all channels.
		- The configuration via chipscope is not supported.
		- The Python scripts can be used to do the rx alignment.
			- Use software to do the rx alignment.
			   - Run *python gbt\_config\_RecRxUsrClk\_SW.py 0*, use 1 for Wide-bus mode.
			- Use firmware to do the rx alignment. (Since FELIX doesn't need this mode, it's not supported in current version firmware. But the FELIX\_GBT\_RX\_ALIGN\_FSM.vhd and gbt\_config\_RecRxUsrClk\_SW.py can be referred, to write a FSM to do similar operations what the python script does.)


4. Some possible settings may need to be changed.
	- Time domain crossing from 40 MHz to TxUsrClk.
		- When using chipscope:
		- When using python:
	- When high percent logic resources are used, to make the data from TxGearBox to GTH Transmitter more stable, the latech enable TX\_GEARBOX\_LATCH\_EN can be set to '1'. One stage of latch is added, this will increase 1/240M latency for Tx side.
	- When a very high percent logic resources are used, for example 90% in FELIX. The GBT decoder processing may not be able to finish in 3 1/240M cycles. If timing errors happen, then the FEC can be changed to 4, and the multi-cycle path constraint for this part should also be changed. To set Setup=4, hold=3. This increase the Rx latency for FEC mode, by 1/240M.
	- Also the pblocks can be used to limit the GBT logic to some region, then we don't need to enable TX\_GEARBOX\_LATCH\_EN. Most of the time, the FEC decoder can also can be finished in 3 cycles. This can make the latency smaller.
	- The Rx alignment topbot selection. May need to change the Rx alignment topbot selection boundary. See the FELIX\_GBT slides for the details.
	- For other settings, please see the FELIX\_GBT\_MANUAL.pdf.

5. Some information for the use of the core.
	- When the TTC clock needs to be recovered from the GBT link, RxOutClk of the master channel is 240MHz. A mmcm can be used to generate the 40MHz. From 240MHz to 40M may has 6 possible phases, the descrambler_enable signal from FELIX GBT can be used to do the phase check, to obtain a fixed phase. Also the OddEven for this channel can be used to solve the oddeven problem (generate a 1 UI uncertainty).
	- Doesn't like CERN GBT-FPGA core, the Rx\_Data\_Valid is not provided. The FELIX GBT module outputs the 4 bit header, and also the Header_Locked signal. When the RxGearBox find the GBT header, this signal is set to '1'. When the header is lost for a continuous 2 GBT frames, it's pull down to '0', then the RxGearBox and the Rx alignment FSM will do the Header finding again.
		- This signal and the 4 bit header can be used by external logic, to generate RxDataValid or other signal as you want.

6. The Tx & Rx automatically reset is not added for thie version, will be enabled in next version.

7. Though most of the functions have been tested and verified, we don't guantee it works well in your project, especially when with different FPGAs.
